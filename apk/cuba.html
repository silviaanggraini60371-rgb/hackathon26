<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Open Data Analytics Platform</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Deck.gl (Standalone version) -->
<script src="https://unpkg.com/deck.gl@8.9.34/dist.min.js"></script>

<!-- Note: MapLibre removed to prevent SecurityError in sandbox environments. 
     We will render the data visualization on a plain dark canvas which fits the theme perfectly. -->

<style>
    body {
        background-color: #0b1220;
        color: #e5e7eb;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }
    
    .card {
        background-color: #111827;
        border: 1px solid #1f2937;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #111827; 
    }
    ::-webkit-scrollbar-thumb {
        background: #374151; 
        border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #4b5563; 
    }

    /* DeckGL Container Fix */
    #map-container {
        position: relative;
        width: 100%;
        height: 300px;
        border-radius: 0.375rem;
        overflow: hidden;
        background-color: #000; /* Deep black background for map */
    }
</style>
</head>

<body class="p-4 md:p-6 min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xl font-bold tracking-tight text-white">Open Data Analytics <span class="text-blue-500">Platform</span></h1>
            <p class="text-xs text-gray-500">Realtime Ingestion Pipeline & Monitoring</p>
        </div>
        <div class="flex gap-2">
            <button class="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded transition">Refresh Source</button>
            <div class="px-3 py-1 text-xs bg-green-900/30 text-green-400 border border-green-900 rounded flex items-center gap-2">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                Live
            </div>
        </div>
    </header>

    <!-- KPI BAR -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="card p-4">
            <div class="flex justify-between items-start">
                <div class="text-xs text-gray-400 font-medium uppercase tracking-wider">Datasets</div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>
            </div>
            <div id="kpi-datasets" class="text-2xl font-bold mt-2 text-white">—</div>
        </div>
        <div class="card p-4">
             <div class="flex justify-between items-start">
                <div class="text-xs text-gray-400 font-medium uppercase tracking-wider">Records</div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z" /></svg>
            </div>
            <div id="kpi-records" class="text-2xl font-bold mt-2 text-white">—</div>
        </div>
        <div class="card p-4">
             <div class="flex justify-between items-start">
                <div class="text-xs text-gray-400 font-medium uppercase tracking-wider">Pipeline Lag</div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div id="kpi-lag" class="text-2xl font-bold mt-2 text-blue-400">—</div>
        </div>
        <div class="card p-4">
             <div class="flex justify-between items-start">
                <div class="text-xs text-gray-400 font-medium uppercase tracking-wider">Quality Score</div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div id="kpi-quality" class="text-2xl font-bold mt-2 text-green-400">—</div>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 flex-grow">

        <!-- TIMESERIES CHART -->
        <div class="card col-span-1 md:col-span-7 p-5 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-sm font-semibold text-gray-300">Ingestion Trend (30 Days)</h2>
                <select class="bg-gray-800 border border-gray-700 text-xs rounded px-2 py-1 text-gray-400 outline-none">
                    <option>Daily</option>
                    <option>Hourly</option>
                </select>
            </div>
            <div class="flex-grow relative" style="min-height: 250px;">
                <svg id="chart" width="100%" height="100%"></svg>
            </div>
        </div>

        <!-- SPATIAL MAP -->
        <div class="card col-span-1 md:col-span-5 p-5 flex flex-col">
            <h2 class="text-sm font-semibold text-gray-300 mb-4">Geospatial Distribution</h2>
            <div id="map-container">
                <canvas id="deck-canvas"></canvas>
            </div>
        </div>

        <!-- DATASETS TABLE -->
        <div class="card col-span-1 md:col-span-8 p-5">
            <h2 class="text-sm font-semibold text-gray-300 mb-4">Active Datasets</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-xs text-left" id="dataset-table">
                    <!-- JS Injected -->
                </table>
            </div>
        </div>

        <!-- EXPLAINABILITY DRAWER -->
        <div class="card col-span-1 md:col-span-4 p-5 flex flex-col">
            <h2 class="text-sm font-semibold text-gray-300 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                AI Explainability
            </h2>
            <div class="bg-gray-900/50 rounded p-3 flex-grow font-mono text-xs text-gray-400 overflow-y-auto border border-gray-800" id="explain">
                Initializing inference engine...
            </div>
        </div>

    </div>

    <!-- FOOTER -->
    <footer class="mt-6 text-center text-[10px] text-gray-600">
        System Architecture: Python ETL &bull; Apache Airflow &bull; PostgreSQL &bull; Docker &bull; Generated by Creative Technologist AI
    </footer>

    <script>
    // ---------------- CONFIG & MOCK DATA ----------------

    const COLORS = {
        primary: "#3b82f6", // blue-500
        success: "#4ade80", // green-400
        danger: "#ef4444",  // red-500
        grid: "#1f2937"     // gray-800
    };

    async function fetchMetrics(){
        // Simulating API Latency
        return new Promise(resolve => setTimeout(() => {
            resolve({
                datasets: 12,
                records: 2340500 + Math.floor(Math.random() * 100), // Live update simulation
                lag: "14s",
                quality: 0.97
            });
        }, 300));
    }

    async function fetchTimeseries(){
        // Generate trend data
        return d3.range(30).map(i => ({
            date: new Date(Date.now() - (29 - i) * 86400000),
            value: 40 + Math.random() * 60
        }));
    }

    async function fetchDatasets(){
        return [
            {id: "ID-HLT-001", title: "RSUD Bed Occupancy", sector: "Health", quality: 0.96, last_update: "2m ago"},
            {id: "ID-ECO-042", title: "Regional Market Prices", sector: "Economy", quality: 0.98, last_update: "5m ago"},
            {id: "ID-EDU-103", title: "School Enrollment 2023", sector: "Education", quality: 0.95, last_update: "1h ago"},
            {id: "ID-TRN-007", title: "Toll Road Traffic Flow", sector: "Transport", quality: 0.92, last_update: "30s ago"}
        ];
    }

    // ---------------- INITIALIZATION ----------------

    document.addEventListener('DOMContentLoaded', async () => {
        
        // 1. Load Metrics
        updateDashboard();

        // 2. Load Chart
        const trendData = await fetchTimeseries();
        renderChart(trendData);

        // 3. Load Map (Safe Mode)
        initMap();

        // 4. Load Datasets
        const datasetData = await fetchDatasets();
        renderTable(datasetData);
        renderExplanation(datasetData);

        // 5. Start Polling
        setInterval(async () => {
            const m = await fetchMetrics();
            updateKPIs(m);
        }, 3000);
    });

    // ---------------- LOGIC ----------------

    function updateKPIs(m) {
        // Animate numbers slightly for realism
        document.getElementById('kpi-datasets').innerText = m.datasets;
        document.getElementById('kpi-records').innerText = m.records.toLocaleString();
        document.getElementById('kpi-lag').innerText = m.lag;
        document.getElementById('kpi-quality').innerText = (m.quality * 100).toFixed(1) + "%";
    }

    async function updateDashboard() {
        const m = await fetchMetrics();
        updateKPIs(m);
    }

    function renderChart(data) {
        const container = document.getElementById("chart");
        const parent = container.parentElement;
        const width = parent.clientWidth;
        const height = parent.clientHeight; // Use full container height

        const svg = d3.select("#chart")
            .attr("viewBox", [0, 0, width, height]);

        const margin = {top: 10, right: 10, bottom: 20, left: 30};

        const x = d3.scaleTime()
            .domain(d3.extent(data, d => d.date))
            .range([margin.left, width - margin.right]);

        const y = d3.scaleLinear()
            .domain([0, 100])
            .range([height - margin.bottom, margin.top]);

        // Gradient for line
        const defs = svg.append("defs");
        const gradient = defs.append("linearGradient")
            .attr("id", "line-gradient")
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", 0).attr("y1", y(0))
            .attr("x2", 0).attr("y2", y(100));
        
        gradient.append("stop").attr("offset", "0%").attr("stop-color", COLORS.primary);
        gradient.append("stop").attr("offset", "100%").attr("stop-color", "#60a5fa");

        // Line path
        svg.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "url(#line-gradient)")
            .attr("stroke-width", 2.5)
            .attr("d", d3.line()
                .curve(d3.curveMonotoneX)
                .x(d => x(d.date))
                .y(d => y(d.value))
            );

        // Axes
        svg.append("g")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x).ticks(5).tickSize(0).tickPadding(10))
            .select(".domain").remove(); // Remove axis line for clean look

        svg.selectAll(".tick text").attr("fill", "#6b7280");

        svg.append("g")
            .attr("transform", `translate(${margin.left},0)`)
            .call(d3.axisLeft(y).ticks(3).tickSize(-width).tickPadding(5))
            .select(".domain").remove();
            
        svg.selectAll(".tick line").attr("stroke", COLORS.grid).attr("stroke-dasharray", "2,2");
        svg.selectAll(".tick text").attr("fill", "#6b7280");
    }

    function initMap() {
        // We use DeckGL without a base map provider (like Mapbox/MapLibre)
        // This avoids the SecurityError in sandboxed iframes.
        const deckgl = new deck.DeckGL({
            container: 'map-container',
            canvas: 'deck-canvas',
            initialViewState: {
                longitude: 106.82,
                latitude: -6.17,
                zoom: 10,
                pitch: 45,
                bearing: 0
            },
            controller: true,
            // Explicitly disable map integration
            map: false,
            layers: [
                new deck.ScatterplotLayer({
                    id: 'scatterplot-layer',
                    data: [
                        {position: [106.82, -6.17], size: 100, color: [59, 130, 246]},
                        {position: [106.85, -6.20], size: 100, color: [239, 68, 68]},
                        {position: [106.80, -6.15], size: 100, color: [74, 222, 128]},
                        {position: [106.75, -6.25], size: 100, color: [255, 255, 255]},
                        {position: [106.90, -6.10], size: 100, color: [255, 200, 0]}
                    ],
                    pickable: true,
                    opacity: 0.8,
                    stroked: true,
                    filled: true,
                    radiusScale: 6,
                    radiusMinPixels: 5,
                    radiusMaxPixels: 100,
                    lineWidthMinPixels: 1,
                    getPosition: d => d.position,
                    getFillColor: d => d.color,
                    getLineColor: d => [0, 0, 0]
                })
            ],
            getTooltip: ({object}) => object && `Location Node\nLat: ${object.position[1]}\nLon: ${object.position[0]}`
        });
    }

    function renderTable(rows) {
        const table = document.getElementById("dataset-table");
        let html = `
            <thead>
                <tr class="text-gray-500 border-b border-gray-700">
                    <th class="pb-2 font-medium">ID</th>
                    <th class="pb-2 font-medium">Title</th>
                    <th class="pb-2 font-medium">Sector</th>
                    <th class="pb-2 font-medium text-right">Quality</th>
                    <th class="pb-2 font-medium text-right">Updated</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-800">`;
        
        rows.forEach(r => {
            // Quality color logic
            let qColor = r.quality > 0.95 ? "text-green-400" : (r.quality > 0.9 ? "text-yellow-400" : "text-red-400");
            
            html += `
            <tr class="hover:bg-gray-800/50 transition cursor-pointer">
                <td class="py-3 font-mono text-gray-400">${r.id}</td>
                <td class="py-3 font-medium text-white">${r.title}</td>
                <td class="py-3">
                    <span class="bg-gray-700 text-gray-300 px-2 py-0.5 rounded text-[10px] uppercase tracking-wider">${r.sector}</span>
                </td>
                <td class="py-3 text-right ${qColor} font-bold">${(r.quality * 100).toFixed(1)}%</td>
                <td class="py-3 text-right text-gray-500">${r.last_update}</td>
            </tr>`;
        });
        
        html += `</tbody>`;
        table.innerHTML = html;
    }

    function renderExplanation(data) {
        const pre = document.getElementById("explain");
        const timestamp = new Date().toISOString();
        
        pre.innerHTML = `
<span class="text-blue-400">INFO</span> [${timestamp}] Inference Engine started.
<span class="text-green-400">PASS</span> Schema validation check.
<span class="text-green-400">PASS</span> Integrity hash check (SHA-256).

<span class="text-yellow-400">WARN</span> Detected anomaly in "Transport" sector:
      Traffic flow variance > 15% from historical mean.

<span class="text-purple-400">INSIGHT GENERATION:</span>
Based on current ingestion rates:
1. Health sector data is highly consistent (96% Quality).
2. Economy sector showing rapid updates (Last: 5m ago).

<span class="text-gray-500">// Source Metadata Sample:</span>
<span class="text-gray-300">${JSON.stringify(data[0], null, 2)}</span>
`;
    }

    </script>
</body>
</html>